# DStack VPN Experiment

A WireGuard-based VPN system for DStack applications that enables secure, private communication between DStack instances with NFT-based access control.

## Overview

This project implements the MVP (Minimum Viable Product) for the DStack VPN functionality specification. It provides:

- WireGuard VPN containers for secure peer-to-peer communication
- Basic NFT-based access control demonstration
- Mullvad UDP-to-TCP proxy for tunneling support
- Docker Compose setup for easy local testing
- Integration with distributed PostgreSQL (stretch goal)

## Quick Start

### Prerequisites

- Docker and Docker Compose
- WireGuard tools (for key generation)
- Linux kernel with WireGuard support (or Docker with privileged containers)

### Setup

1. **Clone the repository**
   ```bash
   git clone <repository-url>
   cd dstack-vpn-experiment
   ```

2. **Generate WireGuard keys**
   ```bash
   ./scripts/generate-keys.sh
   ```
   This creates:
   - `config/node-a/wg0.conf` - Node A WireGuard configuration
   - `config/node-b/wg0.conf` - Node B WireGuard configuration
   - Private and public keys for both nodes

3. **Start the VPN network**
   ```bash
   docker-compose up -d
   ```

4. **Verify connectivity**
   ```bash
   # Check container status
   docker-compose ps
   
   # Test connectivity between nodes
   docker exec wireguard-node-a ping -c 3 10.0.0.2
   docker exec wireguard-node-b ping -c 3 10.0.0.1
   
   # Test HTTP connectivity
   docker exec test-client wget -qO- http://nginx-server:80
   ```

## Architecture

```
┌─────────────────┐    ┌─────────────────┐
│   Node A        │    │   Node B        │
│                 │    │                 │
│  ┌───────────┐  │    │  ┌───────────┐  │
│  │ WireGuard │  │    │  │ WireGuard │  │
│  │ Container │  │    │  │ Container │  │
│  └───────────┘  │    │  └───────────┘  │
│                 │    │                 │
│  ┌───────────┐  │    │  ┌───────────┐  │
│  │   nginx   │  │    │  │  Test     │  │
│  │ Container │  │    │  │  Client   │  │
│  └───────────┘  │    │  └───────────┘  │
└─────────────────┘    └─────────────────┘
         │                       │
         └───────────────────────┘
                    │
         ┌─────────────────────┐
         │   Docker Network    │
         │   (172.20.0.0/16)   │
         └─────────────────────┘
```

## Network Configuration

- **VPN Network**: 10.0.0.0/24
- **Node A IP**: 10.0.0.1
- **Node B IP**: 10.0.0.2
- **WireGuard Port**: 51820/UDP
- **Docker Network**: 172.20.0.0/16

## Services

### Core Services

- **node-a**: WireGuard VPN container for Node A
- **node-b**: WireGuard VPN container for Node B
- **nginx-server**: Test web server on Node A
- **test-client**: Test client on Node B

### Optional Services

- **mullvad-proxy**: UDP-to-TCP proxy for tunneling support

## Testing

### Basic Connectivity Test

```bash
# Test ping between nodes
docker exec wireguard-node-a ping -c 3 10.0.0.2
docker exec wireguard-node-b ping -c 3 10.0.0.1
```

### HTTP Connectivity Test

```bash
# Test HTTP access from Node B to Node A
docker exec test-client wget -qO- http://nginx-server:80
```

### WireGuard Status

```bash
# Check WireGuard interface status
docker exec wireguard-node-a wg show
docker exec wireguard-node-b wg show
```

### Network Diagnostics

```bash
# Check network interfaces
docker exec wireguard-node-a ip addr show
docker exec wireguard-node-b ip addr show

# Check routing table
docker exec wireguard-node-a ip route show
docker exec wireguard-node-b ip route show
```

## Configuration

### WireGuard Configuration

The WireGuard configurations are automatically generated by the `generate-keys.sh` script. Each node gets:

- Unique private/public key pair
- Static IP address in the 10.0.0.0/24 range
- Peer configuration for the other node
- iptables rules for NAT and forwarding

### Docker Configuration

The Docker Compose file sets up:

- Privileged containers with NET_ADMIN and SYS_MODULE capabilities
- Volume mounts for WireGuard configurations
- Health checks for connectivity monitoring
- Network isolation with bridge networking

## Security Considerations

- Private keys are stored with 600 permissions
- WireGuard configurations are read-only in containers
- Network isolation prevents unauthorized access
- iptables rules provide additional security

## Troubleshooting

### Common Issues

1. **WireGuard module not loaded**
   ```bash
   # Check if module is loaded
   lsmod | grep wireguard
   
   # Load module manually (if needed)
   sudo modprobe wireguard
   ```

2. **Container networking issues**
   ```bash
   # Check container logs
   docker-compose logs node-a
   docker-compose logs node-b
   
   # Restart containers
   docker-compose restart node-a node-b
   ```

3. **Key generation issues**
   ```bash
   # Ensure wireguard-tools is installed
   which wg
   
   # Regenerate keys
   rm -rf config/node-*
   ./scripts/generate-keys.sh
   ```

### Debug Commands

```bash
# Check container status
docker-compose ps

# View container logs
docker-compose logs -f node-a

# Execute commands in containers
docker exec -it wireguard-node-a sh
docker exec -it wireguard-node-b sh

# Check network connectivity
docker exec wireguard-node-a ping 10.0.0.2
```

## Development

### Project Structure

```
dstack-vpn-experiment/
├── docker/
│   ├── wireguard/
│   │   ├── Dockerfile
│   │   └── entrypoint.sh
│   └── mullvad-proxy/
│       ├── Dockerfile
│       └── proxy.sh
├── config/
│   ├── node-a/
│   │   └── wg0.conf
│   └── node-b/
│       └── wg0.conf
├── scripts/
│   └── generate-keys.sh
├── docker-compose.yml
├── README.md
└── SPEC.md
```

### Adding New Nodes

1. Create a new config directory: `config/node-c/`
2. Generate keys for the new node
3. Update existing node configurations to include the new peer
4. Add the new service to `docker-compose.yml`

### Customizing Network

To change the network configuration:

1. Modify the IP addresses in `scripts/generate-keys.sh`
2. Update the network CIDR in WireGuard configs
3. Adjust Docker network configuration in `docker-compose.yml`

## Roadmap

### Phase 1 (Current)
- [x] Basic WireGuard setup
- [ ] DStack integration
- [ ] Simple demo with nginx

### Phase 2 (Future)
- [ ] Enhanced configuration management
- [ ] Security enhancements
- [ ] Developer experience improvements

### Phase 3 (Stretch Goals)
- [ ] Distributed PostgreSQL with Patroni
- [ ] Enhanced monitoring
- [ ] Multi-region deployment

## Contributing

1. Fork the repository
2. Create a feature branch
3. Make your changes
4. Test thoroughly
5. Submit a pull request

## License

[Add your license information here]

## Support

For issues and questions:
- Check the troubleshooting section
- Review the logs with `docker-compose logs`
- Open an issue on GitHub 